<!DOCTYPE html>
<html>
<head>
    <title>Shift CSS Â· As in "shift the weight" because writing CSS takes time. A slim CSS framework for web apps.</title>

    <meta charset="utf-8">
    <meta name="description" content="As in 'shift the weight' because writing CSS takes time. A slim CSS framework for web apps.">
    <meta name="author" content="Jordan Ranson">

    <link rel="icon" type="image/png" href="favicon.png">
    <link href="http://fonts.googleapis.com/css?family=Ubuntu+Mono" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600,900" rel="stylesheet" type="text/css">
    <link rel="stylesheet" type="text/css" href="shift.css">
    <link rel="stylesheet" type="text/css" href="site.css">

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0/handlebars.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.7.0/underscore-min.js"></script>
</head>
<body>
    <div class="app">
        <div class="anchor anchor-offset-thick anchor-center">
            <div class="anchor-wrapper">
                <div class="anchor-content" style="height:100%">

                    <!-- Optional panel group -->
                    <div class="panel-group" style="width:780px;height:100%">

                        <!-- Navigation panel -->
                        <div class="panel panel-nav" style="width:30%">
                            <header class="panel-header-borderless">
                                <h1>D&amp;D 5e Tools</h1>
                            </header>
                            <section>
                                <div class="panel-body">

                                    <ul class="list list-nav">
                                        <li class="list-nav-header"><h2>Reference</h2></li>
                                        <li><a href="#" class="active">Spell List</a></li>
                                    </ul>

                                </div>
                            </section>
                        </div>

                        <!-- List view -->
                        <div class="panel" style="width:70%">
                            <header class="panel-header-leftalign">
                                <h1>Spell List</h1>
                                <div class="panel-header-controls">
                                    <div class="input-group input-group-inline">
                                        <input type="text" class="text x-spell-search" placeholder="search">
                                    </div>
                                </div>
                            </header>
                            <section class="panel-content-scroll x-drop-target">
                                <div class="panel-body panel-body-padded x-spells">
                                    <div class="drop-target">
                                        Drop spell data file here.
                                    </div>
                                </div>
                            </section>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <script id="spellTemplate" type="text/x-handlebars">
        {{#each spells}}
            <div class="spell">
                <h2>{{{name}}}</h2>
                <h3>Level {{{level}}}, {{{school}}}{{#if ritual}}, ritual{{/if}}</h3>
                <p><strong>Casting Time</strong> {{{casting_time}}}</p>
                <p><strong>Range</strong> {{{range}}}</p>
                <p><strong>Components</strong> {{{components}}}</p>
                <p><strong>Duration</strong> {{{duration}}}</p>
                <p><strong>Classes</strong> {{{listClasses classes}}}</p>
                <p>{{{description}}}</p>
            </div>
        {{/each}}
    </script>

    <script>
        var spells;

        Handlebars.registerHelper('listClasses', function(classes) {
            var value = '';
            for(var key in classes) {
                if(classes[key] === 'highlight') value += '<span class="term">'+key+'</span><span class="comma">, </span>';
                else if(classes[key]) value += key+'<span class="comma">, </span>';
            }
            return value;
        });

        function renderSpellList(data) {
            var source        = $("#spellTemplate").html();
            var template      = Handlebars.compile(source);
            var html          = template({ spells: data });
            var $xSpells      = $('.x-spells');

            $xSpells.html(html);
        }

        function findMatch(str, query) {
            return !!~(str.toString().toLowerCase().search(query));
        }

        function loadSpellList(data) {
            spells = data;
            renderSpellList(data);

            var $xSpellSearch = $('.x-spell-search');
            var timer;
            $xSpellSearch.on('keyup', function(e) {
                clearTimeout(timer);
                timer = setTimeout(function() {
                    var rawQuery = $(e.target).val();
                    while(!!~rawQuery.search(', ')) {
                        rawQuery = rawQuery.replace(', ', ',')
                    }
                    console.log(rawQuery);

                    var queryArr = rawQuery.split(',');

                    var filteredData = _.filter(JSON.parse(JSON.stringify(spells)), function(spell) {
                        var matched = [];

                        for(var i = 0; i < queryArr.length; i++) {
                            var query = queryArr[i].toLowerCase();
                            var next = false;

                            if(!next && query.length < 3) {
                                next = true;
                            }

                            if(!next && query === '') {
                                matched.push(true);
                                next = true;
                            }

                            if(!next) {
                                if(query === 'cantrip' && spell.level == 0) {
                                    matched.push(true);
                                    next = true;
                                }
                            }

                            if(!next) {
                                if(query === 'ritual' && spell.ritual) {
                                    matched.push(true);
                                    next = true;
                                }
                            }

                            if(!next) {
                                for(var x = 0; x < 10; x++) {
                                    if(query === 'level '+x && spell.level == x) {
                                        matched.push(true);
                                        next = true;
                                        break;
                                    }
                                }
                            }

                            if(!next) {
                                for(var spellClass in spell.classes) {
                                    if (query === spellClass) {
                                        matched.push(true);
                                        next = true;
                                        break;
                                    }
                                }
                            }

                            if(!next) {
                                for (var key in spell) {
                                    if (findMatch(spell[key], query)) {
                                        matched.push(true);
                                        next = true;
                                        break;
                                    }
                                }
                            }
                        }

                        return rawQuery === '' ? true : matched.length >= queryArr.length;
                    });

                    if(rawQuery !== '') {
                        for(var k = 0; k < filteredData.length; k++) {
                            var spell = filteredData[k];

                            for(var i = 0; i < queryArr.length; i++) {
                                var query = queryArr[i];

                                if(query.trim() !== '') {
                                    for (var j in spell) {
                                        var string = spell[j].toString();
                                        if (!!~string.search(query))
                                            spell[j] = string.replace(query, '<span class="term">' + query + '</span>');

                                        if (!!~string.search(query.charAt(0).toUpperCase() + query.slice(1)))
                                            spell[j] = string.replace(query.charAt(0).toUpperCase() + query.slice(1), '<span class="term">' + query.charAt(0).toUpperCase() + query.slice(1) + '</span>');

                                        if (!!~string.search(query.toLowerCase()))
                                            spell[j] = string.replace(query.toLowerCase(), '<span class="term">' + query.toLowerCase() + '</span>');

                                        if (!!~string.search(query.toUpperCase()))
                                            spell[j] = string.replace(query.toUpperCase(), '<span class="term">' + query.toUpperCase() + '</span>');
                                    }
                                }

                                for(var j in spell.classes) {
                                    if(j == query) filteredData[k].classes[j] = 'highlight';
                                }
                            }
                        }
                    }

                    renderSpellList(filteredData);
                }, 350);
            });
        }

        function onDrop(e) {
            e.preventDefault();

            console.log(e);

            var file = e.dataTransfer.files[0];
            var reader = new FileReader();
            reader.onload = function () {
                var data = JSON.parse(this.result);
                loadSpellList(data);
            };
            reader.readAsText(file);
        }

        function onDragOver(e) {
            return false;
        }

        function onDragEnd(e) {
            return false;
        }


        $(function() {
            var $xDropTarget = $('.x-drop-target');
            $xDropTarget.on('dragover', onDragOver);
            $xDropTarget.on('dragend',  onDragEnd);
            $xDropTarget[0].addEventListener('drop', onDrop);

            var localData = null;
            $.get('./spells.json')
            .success(function(data) {
                loadSpellList(data);
            });
        });
    </script>
</body>
</html>