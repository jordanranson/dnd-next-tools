<!DOCTYPE html>
<html>
<head>
    <title>Dungeons and Dragons: Next (5e) Tools</title>

    <meta charset="utf-8">
    <meta name="description" content="A set of tools for Dungeons and Dragons: Next (5e)">
    <meta name="author" content="Jordan Ranson">

    <link rel="icon" type="image/png" href="favicon.png">
    <link href="http://fonts.googleapis.com/css?family=Ubuntu+Mono" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600,900" rel="stylesheet" type="text/css">
    <link rel="stylesheet" type="text/css" href="shift.css">
    <link rel="stylesheet" type="text/css" href="site.css">

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0/handlebars.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.7.0/underscore-min.js"></script>
</head>
<body>
    <div class="app">
        <div class="anchor anchor-offset-thick anchor-center">
            <div class="anchor-wrapper">
                <div class="anchor-content" style="height:100%">

                    <!-- Optional panel group -->
                    <div class="panel-group" style="width:1024px;height:100%">

                        <!-- Navigation panel -->
                        <div class="panel panel-nav" style="width:30%">
                            <header class="panel-header-borderless">
                                <h1>D&amp;D 5e Tools</h1>
                            </header>
                            <section>
                                <div class="panel-body">

                                    <ul class="list list-nav x-nav">
                                        <li class="list-nav-header"><h2>Tools</h2></li>
                                        <li><a href="javascript:void(0)" class="x-inventory-nav" data-for="x-inventory-panel">Inventory</a></li>
                                        <li><a href="javascript:void(0)" class="x-spellbook-nav" data-for="x-spellbook-panel">Spell Book</a></li>
                                        <li class="list-nav-header"><h2>Reference</h2></li>
                                        <li><a href="javascript:void(0)" class="x-spell-nav" data-for="x-spell-panel" class="active">Spell List</a></li>
                                    </ul>

                                </div>
                            </section>
                        </div>

                        <div class="panel x-spell-panel x-content-panel" style="width:70%">
                            <header class="panel-header-leftalign">
                                <h1>Spell List</h1>
                                <div class="panel-header-controls" style="width:70%">
                                    <div class="input-group input-group-inline" style="width:100%">
                                        <input type="text" class="text x-spell-search" placeholder="search" style="width:100%">
                                    </div>
                                </div>
                            </header>
                            <section class="panel-content-scroll x-drop-target">
                                <div class="panel-body panel-body-padded x-spells">
                                    <div class="drop-target">
                                        Drop spell data file here.
                                    </div>
                                </div>
                            </section>
                        </div>

                        <div class="panel x-inventory-panel x-content-panel" style="width:70%;display:none">
                            <header class="panel-header-leftalign">
                                <h1>Inventory</h1>
                                <div class="panel-header-controls">
                                    <div class="input-group input-group-inline">
                                        <button class="button button-dangerous x-clear-inventory">Reset</button>
                                    </div>
                                </div>
                            </header>
                            <section class="panel-content-scroll x-drop-target">
                                <div class="panel-body panel-body-padded x-inventory">
                                    <div class="input-group">
                                        <h1>Add Container</h1>
                                        <input type="text" class="text x-container-name" placeholder="container name">
                                        <button class="button button-primary x-add-item-container">Equip</button>
                                    </div>
                                    <br>

                                    <div class="x-item-containers">
                                    </div>
                                </div>
                            </section>
                        </div>


                        <div class="panel x-spellbook-panel x-content-panel" style="width:70%;display:none">
                            <header class="panel-header-leftalign">
                                <h1>Spell Book</h1>
                                <div class="panel-header-controls">
                                    <div class="input-group input-group-inline">
                                        <button class="button button-dangerous x-clear-spellbook">Reset</button>
                                    </div>
                                </div>
                            </header>
                            <section class="panel-content-scroll x-drop-target">
                                <div class="panel-body panel-body-padded x-spellbook">
                                </div>
                            </section>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <script id="spellTemplate" type="text/x-handlebars">
        {{#each spells}}
            <div class="spell" data-name="{{name}}" data-level="{{level}}">
                <h2>{{{name}}} &nbsp;<small><a href="javascript:void(0)" class="x-add-spell-list">Learn</a></small></h2>
                <h3>Level {{{level}}}, {{{school}}}{{#if ritual}}, ritual{{/if}}</h3>
                <p><strong>Casting Time</strong> {{{casting_time}}}</p>
                <p><strong>Range</strong> {{{range}}}</p>
                <p><strong>Components</strong> {{{components}}}</p>
                <p><strong>Duration</strong> {{{duration}}}</p>
                <p><strong>Classes</strong> {{{listClasses classes}}}</p>
                <p>{{{description}}}</p>
            </div>
        {{/each}}
    </script>

    <script id="itemContainerTemplate" type="text/x-handlebars">
        {{#each containers}}
        <div class="group x-item-container" data-id="{{id}}">
            <h1>
                {{name}} &nbsp;
                <small><a class="error x-remove-container" href="javascript:void(0)">Remove</a></small>
            </h1>
            <table class="table table-wide table-inventory">
                <colgroup>
                    <col width="40%">
                    <col width="15%">
                    <col width="25%">
                    <col width="30%">
                </colgroup>
                <thead>
                <tr>
                    <th>Name</th>
                    <th class="cell-center">Qty.</th>
                    <th class="cell-center"><span class="item-value"><span>Value</span><span><em>Total Value</em></span></span></th>
                    <th class="cell-right"></th>
                </tr>
                </thead>
                <tbody>
                <tr class="input-row x-input-row">
                    <td><input type="text" class="text x-item-name" placeholder="name" name="item-name"></td>
                    <td class="cell-center"><input type="text" class="text cell-center x-item-qty" placeholder="qty"></td>
                    <td class="cell-center"><input type="text" class="text cell-center x-item-value" placeholder="value"></td>
                    <td class="cell-center"><button class="button x-add-item">Add</button></td>
                </tr>
                {{#each items}}
                <tr class="x-item-row" data-id="{{id}}">
                    <td>{{name}}</td>
                    <td class="cell-center"><a href="javascript:void(0)" class="x-change-item-qty">{{qty}}</a></td>
                    <td class="cell-center"><span class="item-value"><span>{{displayValue value}}</span><span><em>{{totalValue value qty}}</em></span></span></td>
                    <td class="cell-center"><a href="javascript:void(0)" class="x-remove-item error">Remove</a></td>
                </tr>
                {{/each}}
                </tbody>
            </table>
        </div>
        {{/each}}
    </script>

    <script id="spellbookTemplate" type="text/x-handlebars">
        <table class="table table-wide table-inventory">
            <colgroup>
                <col width="50%">
                <col width="15%">
                <col width="35%">
            </colgroup>
            <thead>
            <tr>
                <th><a href="javascript:void(0)" class="x-sort-spell-level">Name</a></th>
                <th class="cell-center"><a href="javascript:void(0)" class="x-sort-spell-level">Level</a></th>
                <th class="cell-center"></th>
            </tr>
            </thead>
            <tbody>
            <tr class="input-row x-input-row">
                <td>
                    <input type="text" class="text x-spell-name" placeholder="spell name">
                </td>
                <td class="cell-center">
                    <input type="text" class="text cell-center x-spell-level" placeholder="level">
                </td>
                <td class="cell-center">
                    <button class="button x-add-spell">Learn</button>
                </td>
            </tr>
            {{#each spells}}
            <tr class="x-item-row" data-id="{{id}}" data-name="{{name}}">
                <td>{{name}}</td>
                <td class="cell-center">{{level}}</td>
                <td class="cell-center">
                    <a href="javascript:void(0)" class="x-view-spell">View in Spell List</a>&nbsp;&nbsp;
                    <a href="javascript:void(0)" class="x-remove-spell error">Remove</a>
                </td>
            </tr>
            {{/each}}
            </tbody>
        </table>
    </script>

    <script>
        var _spells = null;

        Handlebars.registerHelper('listClasses', function(classes) {
            var value = '';
            for(var key in classes) {
                if(classes[key] === 'highlight') value += '<span class="term">'+key+'</span><span class="comma">, </span>';
                else if(classes[key]) value += key+'<span class="comma">, </span>';
            }
            return value;
        });

        Handlebars.registerHelper('totalValue', function(value, qty) {
            return formatGold(value * qty);
        });

        Handlebars.registerHelper('displayValue', function(value) {
            return formatGold(value);
        });

        String.uuid = (function() {
            function s4() {
                return Math.floor((1 + Math.random()) * 0x10000)
                        .toString(16)
                        .substring(1);
            }
            return function() {
                return s4() + s4() + '-' + s4() + '-' + s4() + '-' +
                        s4() + '-' + s4() + s4() + s4();
            };
        })();

        function formatGold(amount) {
            var string = '';

            /*string += amount % (100 * 100 * 100);
            string += 'g ';
            string += amount / 100 % (100 * 100 * 100);
            string += 's ';
            string += amount % (100 * 100 * 100);
            string += 'c ';*/

            var gold   = Math.floor(amount / 100 / 100);
            var silver = Math.floor(((amount  - (gold * 100 * 100)) / 100));
            var copper = amount - (gold * 100 * 100) - (silver * 100);

            if(gold   > 0) string += gold   + 'g ';
            if(silver > 0) string += silver + 's ';
            if(copper > 0) string += copper + 'c ';

            return string;
        }

        function renderSpellList(data) {
            var source        = $("#spellTemplate").html();
            var template      = Handlebars.compile(source);
            var html          = template({ spells: data });
            var $xSpells      = $('.x-spells');

            $xSpells.html(html);
        }

        function findMatch(str, query) {
            return !!~(str.toString().toLowerCase().search(query));
        }

        function loadSpellList(data, query) {
            renderSpellList(data);

            var $xSpellSearch = $('.x-spell-search');
            $xSpellSearch.val(query || '');
            $xSpellSearch.trigger('keyup');
        }

        function onDrop(e) {
            e.preventDefault();

            var file = e.dataTransfer.files[0];
            var reader = new FileReader();
            reader.onload = function () {
                var data = JSON.parse(this.result);
                _spells = data;
                loadSpellList(data);
            };
            reader.readAsText(file);
        }

        function onDragOver(e) {
            return false;
        }

        function onDragEnd(e) {
            return false;
        }

        function render(selector, model, $container) {
            var source   = $(selector).html();
            var template = Handlebars.compile(source);
            var html     = template(model);
            $container.html(html);
        }

        function loadInventoryPanel() {
            var $xItemContainers = $('.x-item-containers');
            var backpack = {
                id    : String.uuid(),
                name  : "Adventurer's Backpack",
                items : []
            };
            var containerData  = JSON.parse(localStorage.getItem('inventory_data')) || [backpack];
            var containerModel = { containers: containerData };

            localStorage.setItem('inventory_data', JSON.stringify(containerData));

            render('#itemContainerTemplate', containerModel, $xItemContainers);
        }

        function loadSpellPanel(query) {
            if(!_spells) {
                $.get('./spells.json')
                .success(function(data) {
                    _spells = data;
                    loadSpellList(data, query);
                });
            }
            else {
                loadSpellList(_spells, query);
            }
        }

        function loadSpellbookPanel(sortBy) {
            var $xSpellbook    = $('.x-spellbook');
            var spellbookData  = JSON.parse(localStorage.getItem('spellbook_data')) || [];

            var spellbookModel = { spells: _.sortBy(spellbookData, function(item) {
                return (sortBy && item[sortBy.value]) || item.name;
            })};
            if(sortBy && sortBy.desc) spellbookModel.spells.reverse();

            localStorage.setItem('spellbook_data', JSON.stringify(spellbookData));
            render('#spellbookTemplate', spellbookModel, $xSpellbook);
        }

        function route(container) {
            switch(container) {
                case '.x-inventory-panel' : loadInventoryPanel(); break;
                case '.x-spell-panel'     : loadSpellPanel(); break;
                case '.x-spellbook-panel' : loadSpellbookPanel(); break;
            }
        }

        $(function() {
            var $body = $('body');

            var $xDropTarget = $('.x-drop-target');
            $xDropTarget.on('dragover', onDragOver);
            $xDropTarget.on('dragend',  onDragEnd);
            $xDropTarget[0].addEventListener('drop', onDrop);

            route('.x-spell-panel');

            $body.on('click', '.x-nav a', function(e) {
                var $tar = $(e.target);
                var forContainer = '.'+$tar.attr('data-for');

                $('.x-content-panel').hide();
                $(forContainer).show();

                $('.x-nav a').removeClass('active');
                $tar.addClass('active');

                route(forContainer);
            });

            var timer;
            var $xSpellSearch = $('.x-spell-search');
            $xSpellSearch.on('keyup', function(e) {
                clearTimeout(timer);
                timer = setTimeout(function() {
                    var rawQuery = $(e.target).val();
                    while(!!~rawQuery.search(', ')) {
                        rawQuery = rawQuery.replace(', ', ',')
                    }

                    var queryArr = rawQuery.split(',');

                    var filteredData = _.filter(JSON.parse(JSON.stringify(_spells)), function(spell) {
                        var matched = [];

                        for(var i = 0; i < queryArr.length; i++) {
                            var queryParams = queryArr[i].toLowerCase().split('|');


                            for(var w = 0; w < queryParams.length; w++) {
                                var query = queryParams[w];
                                var next = false;

                                if (!next && query.length < 3) {
                                    next = true;
                                }

                                if (!next && query === '') {
                                    matched.push(true);
                                    next = true;
                                }

                                if (!next) {
                                    if (query === 'cantrip' && spell.level == 0) {
                                        matched.push(true);
                                        next = true;
                                    }
                                }

                                if (!next) {
                                    if (query === 'ritual' && spell.ritual) {
                                        matched.push(true);
                                        next = true;
                                    }
                                }

                                if (!next) {
                                    for (var x = 0; x < 10; x++) {
                                        if (query === 'level ' + x && spell.level == x) {
                                            matched.push(true);
                                            next = true;
                                            break;
                                        }
                                    }
                                }

                                if (!next) {
                                    for (var spellClass in spell.classes) {
                                        if (query === spellClass) {
                                            matched.push(true);
                                            next = true;
                                            break;
                                        }
                                    }
                                }

                                if (!next) {
                                    for (var key in spell) {
                                        if (findMatch(spell[key], query)) {
                                            matched.push(true);
                                            next = true;
                                            break;
                                        }
                                    }
                                }
                            }
                        }

                        return rawQuery === '' ? true : matched.length >= queryArr.length;
                    });

                    if(rawQuery !== '') {
                        for(var k = 0; k < filteredData.length; k++) {
                            var spell = filteredData[k];

                            for(var i = 0; i < queryArr.length; i++) {
                                var queryParams = queryArr[i].split('|');

                                for(var w = 0; w < queryParams.length; w++) {
                                    var query = queryParams[w];

                                    if (query.trim() !== '') {
                                        for (var j in spell) {
                                            var string = spell[j].toString();
                                            if (!!~string.search(query))
                                                spell[j] = string.replace(query, '<span class="term">' + query + '</span>');

                                            if (!!~string.search(query.charAt(0).toUpperCase() + query.slice(1)))
                                                spell[j] = string.replace(query.charAt(0).toUpperCase() + query.slice(1), '<span class="term">' + query.charAt(0).toUpperCase() + query.slice(1) + '</span>');

                                            if (!!~string.search(query.toLowerCase()))
                                                spell[j] = string.replace(query.toLowerCase(), '<span class="term">' + query.toLowerCase() + '</span>');

                                            if (!!~string.search(query.toUpperCase()))
                                                spell[j] = string.replace(query.toUpperCase(), '<span class="term">' + query.toUpperCase() + '</span>');
                                        }
                                    }

                                    for (var j in spell.classes) {
                                        if (j == query) filteredData[k].classes[j] = 'highlight';
                                    }
                                }
                            }
                        }
                    }

                    renderSpellList(filteredData);
                }, 350);
            });


            /*
             * Inventory
             */

            $body.on('click', '.x-add-item-container', function(e) {
                var $xContainerName = $('.x-container-name');
                var containerName   = $xContainerName.val().trim();

                if(containerName.length === 0) return;

                var container = {
                    id    : String.uuid(),
                    name  : containerName,
                    items : []
                };

                var containers = JSON.parse(localStorage.getItem('inventory_data'));
                containers.push(container);

                localStorage.setItem('inventory_data', JSON.stringify(containers));
                route('.x-inventory-panel');
            });

            $body.on('click', '.x-remove-container', function(e) {
                if(!confirm('Are you sure you want to destroy this container?')) return;

                var $tar = $(e.target);
                var id   = $tar.closest('.x-item-container').attr('data-id');

                var containers = JSON.parse(localStorage.getItem('inventory_data'));
                for(var i = 0; i < containers.length; i++) {
                    var c = containers[i];
                    if(c.id === id) {
                        containers.splice(i, 1);
                        break;
                    }
                }

                localStorage.setItem('inventory_data', JSON.stringify(containers));
                route('.x-inventory-panel');
            });

            $body.on('click', '.x-clear-inventory', function(e) {
                if(!confirm('Are you sure you want reset your inventory?')) return;

                localStorage.removeItem('inventory_data');
                route('.x-inventory-panel');
            });

            $body.on('click', '.x-add-item', function(e) {
                var $tar   = $(e.target);
                var $table = $tar.closest('table');

                var id     = $tar.closest('.x-item-container').attr('data-id');
                var name   = $table.find('.x-item-name').val();
                var qty    = $table.find('.x-item-qty').val();
                var value  = $table.find('.x-item-value').val();

                if(name === '' || !(Number(qty) >= 0) || !(Number(value) >= 0) ) return;

                if(!!~value.search('c')) value = value.replace('c', '').trim();
                else if(!!~value.search('s')) value = Number(value.replace('s', '').trim()) * 100;
                else value = Number(value.replace('g', '').trim()) * 100 * 100;

                //value = value.split('.');
                //value = value[0] * (value[1] * 100) + (value[2] * 100 * 100);

                var containers = JSON.parse(localStorage.getItem('inventory_data'));
                for(var i = 0; i < containers.length; i++) {
                    var c = containers[i];
                    if(c.id === id) {
                        c.items.push({
                            id    : String.uuid(),
                            name  : name,
                            qty   : qty,
                            value : value
                        });
                        break;
                    }
                }

                localStorage.setItem('inventory_data', JSON.stringify(containers));
                route('.x-inventory-panel');
            });

            $body.on('click', '.x-remove-item', function(e) {
                if(!confirm('Are you sure you want to destroy this item?')) return;

                var $tar = $(e.target);
                var cid  = $tar.closest('.x-item-container').attr('data-id');
                var iid  = $tar.closest('.x-item-row').attr('data-id');

                var containers = JSON.parse(localStorage.getItem('inventory_data'));
                for(var i = 0; i < containers.length; i++) {
                    var c = containers[i];
                    if(c.id === cid) {
                        for(var k = 0; k < c.items.length; k++) {
                            var item = c.items[k];
                            if(item.id === iid) {
                                c.items.splice(k,1);
                                break;
                            }
                        }
                    }
                }

                localStorage.setItem('inventory_data', JSON.stringify(containers));
                route('.x-inventory-panel');
            });

            $body.on('click', '.x-change-item-qty', function(e) {
                var amount = prompt('Adjust quantity by how much?');
                if(typeof amount !== 'number' && !~amount.toString().search('.')) return;

                var $tar = $(e.target);
                var cid  = $tar.closest('.x-item-container').attr('data-id');
                var iid  = $tar.closest('.x-item-row').attr('data-id');

                var containers = JSON.parse(localStorage.getItem('inventory_data'));
                for(var i = 0; i < containers.length; i++) {
                    var c = containers[i];
                    if(c.id === cid) {
                        for(var k = 0; k < c.items.length; k++) {
                            var item = c.items[k];
                            if(item.id === iid) {
                                item.qty = Number(item.qty) + Number(amount);
                                break;
                            }
                        }
                    }
                }

                localStorage.setItem('inventory_data', JSON.stringify(containers));
                route('.x-inventory-panel');
            });


            /*
             * Spell book
             */

            $body.on('click', '.x-add-spell', function(e) {
                var $tar = $(e.target);

                var spellbook = JSON.parse(localStorage.getItem('spellbook_data'));
                var spell     = {
                    id    : String.uuid(),
                    name  : $tar.closest('table').find('.x-spell-name').val(),
                    level : $tar.closest('table').find('.x-spell-level').val()
                };
                spellbook.push(spell);

                localStorage.setItem('spellbook_data', JSON.stringify(spellbook));
                route('.x-spellbook-panel');
            });

            $body.on('click', '.x-add-spell-list', function(e) {
                var $tar = $(e.target);

                var spellbook = JSON.parse(localStorage.getItem('spellbook_data'));
                var spell     = {
                    id    : String.uuid(),
                    name  : $tar.closest('.spell').attr('data-name'),
                    level : $tar.closest('.spell').attr('data-level')
                };
                spellbook.push(spell);
                localStorage.setItem('spellbook_data', JSON.stringify(spellbook));

                if(confirm('Spell learned! View Spell Book?')) {
                    $('.x-content-panel').hide();
                    $('.x-spellbook-panel').show();

                    $('.x-nav a').removeClass('active');
                    $('.x-spellbook-nav').addClass('active');

                    route('.x-spellbook-panel');
                }
            });

            $body.on('click', '.x-remove-spell', function(e) {
                if(!confirm('Are you sure you want to forget this spell?')) return;

                var $tar = $(e.target);
                var id   = $tar.closest('.x-item-row').attr('data-id');

                var spellbook = JSON.parse(localStorage.getItem('spellbook_data'));
                for(var i = 0; i < spellbook.length; i++) {
                    console.log(spellbook[i]);
                    if(spellbook[i].id == id) {
                        spellbook.splice(i, 1);
                        break;
                    }
                }

                localStorage.setItem('spellbook_data', JSON.stringify(spellbook));
                route('.x-spellbook-panel');
            });

            $body.on('click', '.x-view-spell', function(e) {
                var $tar = $(e.target);
                var spellName = $tar.closest('.x-item-row').attr('data-name');

                $('.x-content-panel').hide();
                $('.x-spell-panel').show();

                $('.x-nav a').removeClass('active');
                $('.x-spell-nav').addClass('active');

                loadSpellPanel(spellName);
            });

            $body.on('click', '.x-clear-spellbook', function(e) {
                if(!confirm('Are you sure you want reset your spell book?')) return;

                localStorage.removeItem('spellbook_data');
                route('.x-spellbook-panel');
            });

            var sortLevelDesc = false;
            $body.on('click', '.x-sort-spell-level', function(e) {
                loadSpellbookPanel({ value: 'level', desc: sortLevelDesc });
                sortLevelDesc = !sortLevelDesc
            });

            var sortNameDesc = false;
            $body.on('click', '.x-sort-spell-name', function(e) {
                loadSpellbookPanel({ value: 'name', desc: sortNameDesc });
                sortNameDesc = !sortNameDesc
            });
        });
    </script>
</body>
</html>